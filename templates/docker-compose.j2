---
version: '3.2'

networks:
  guacnet:
    driver: bridge

services:
  guacd:
    container_name: guacd
    image: "guacamole/guacd"
    networks:
      guacnet:

  postgres:
    container_name: postgres
    environment:
      POSTGRES_PASSWORD: {{ postgres_password }}
    image: "postgres:guac-postgres"
    networks:
      guacnet:
    volumes:
      - /tmp/init:/tmp

  guacamole:
    container_name: guacamole
    depends_on:
      - guacd
      - postgres
    environment:
      POSTGRES_DATABASE: guacamole_db
      POSTGRES_USER: guacamole_user
      POSTGRES_PASSWORD: {{ postgres_password }}
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822
      POSTGRES_HOSTNAME: postgres
      POSTGRES_PORT: 5432
    image: "guacamole/guacamole"
    links:
      - guacd
      - postgres
    networks:
      guacnet:
    ports:
      - "8080"

  nginx:
   container_name: nginx
   image: nginx
   volumes:
     - type: bind
       source: ./nginx/nginx.conf
       target: /etc/nginx/nginx.conf
       read_only: true
     - type: bind
       source: ./nginx/site.template
       target: /etc/nginx/conf.d/site.template
     - type: bind
       source: ./nginx/ssl
       target: /etc/nginx/ssl
   ports:
   - 8443:443
   links:
   - guacamole
   networks:
     guacnet:
   # install openssl, create self-signed certificate and run nginx
   # TODO: Replace self-signed cert with a real cert
   command: /bin/bash -c "apt-get -y update && apt-get -y install openssl && openssl req -nodes -newkey rsa:2048 -new -x509 -keyout /etc/nginx/ssl/self-ssl.key -out /etc/nginx/ssl/self.cert -subj '/C=DE/ST=BY/L=Hintertupfing/O=Dorfwirt/OU=Theke/CN=www.createyourown.domain/emailAddress=docker@createyourown.domain' && cp -f -s /etc/nginx/conf.d/site.template /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
